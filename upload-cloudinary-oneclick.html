<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Upload Product → Cloudinary + Backend (one click)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
    .container { max-width:640px; margin:auto; background:#fff; padding:18px; border-radius:10px; box-shadow:0 2px 12px rgba(0,0,0,.08); }
    input, select, button, textarea { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
    .row{display:flex;gap:8px} .row> *{flex:1}
    button{background:#111;color:#fff;border:none;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .hint{font-size:13px;color:#555}
    .success{color:green;font-weight:700}
    .error{color:#b00020;font-weight:700}
    img.preview{max-width:100%;border-radius:6px;margin-top:8px;display:block}
    progress{width:100%;height:14px}
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload Product — Image → Cloudinary → Backend (one click)</h2>

    <input id="name" placeholder="Product Name" />
    <select id="category">
      <option value="">Select Category</option>
      <option value="flower">Flower</option>
      <option value="animal">Animal</option>
      <option value="festive">Festive</option>
      <option value="special">Special</option>
      <option value="glassJar">Glass Jar</option>
    </select>

    <div class="row">
      <select id="waxType">
        <option value="soy" selected>Soy</option>
        <option value="gel">Gel</option>
      </select>
      <input id="weightGrams" type="number" placeholder="Weight (grams)" />
    </div>

    <div class="row">
      <input id="burnTimeHours" type="text" placeholder="Burn Time (hours)" />
      <input id="price" type="number" placeholder="Price" />
    </div>

    <input id="quantityPack" type="number" placeholder="Quantity Pack" />

    <div class="row">
      <select id="customizableFragrance">
        <option value="true">Fragrance: Yes</option>
        <option value="false">Fragrance: No</option>
      </select>

      <select id="customizableColor">
        <option value="true">Color: Yes</option>
        <option value="false">Color: No</option>
      </select>
    </div>

    <label class="hint">Choose image (preview + optional compression):</label>
    <input id="imageUpload" type="file" accept="image/*" />
    <img id="preview" class="preview" style="display:none" />

    <input id="altText" placeholder="Alt Text" />

    <progress id="progress" value="0" max="100" style="display:none"></progress>
    <button id="uploadBtn">Upload Product</button>
    <p id="msg"></p>

    <p class="hint">Put your Cloudinary <code>CLOUD_NAME</code> and <code>UPLOAD_PRESET</code> into the CONFIG below.</p>
  </div>

<script>
/* ========== CONFIG - set these ========== */
const CLOUD_NAME = 'dlrtaxlcl';        // <-- put your cloud name here
const UPLOAD_PRESET = 'cozy_unsigned';// <-- put your unsigned preset here
const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;

const BACKEND_URL = 'https://cozy-backend-1.onrender.com/api/products';
const ADMIN_SECRET = 'super-secret-token';

/* Compression options */
const MAX_W = 1600;
const MAX_H = 1600;
const QUALITY = 0.75;

/* ====== UI refs ====== */
const fileInput = document.getElementById('imageUpload');
const preview = document.getElementById('preview');
const msg = document.getElementById('msg');
const uploadBtn = document.getElementById('uploadBtn');
const progressEl = document.getElementById('progress');

let preparedFile = null; // Blob/File ready to upload

/* When user selects a file, compress & prepare a Blob for upload */
fileInput.addEventListener('change', async (e) => {
  clearMsg();
  preparedFile = null;
  preview.style.display = 'none';
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  if (!f.type.startsWith('image/')) { showError('Select a valid image file.'); return; }
  if (f.size > 40 * 1024 * 1024) { showError('File too large (>40MB). Choose smaller file.'); return; }

  try {
    const img = await fileToImage(f);
    const dataUrl = await compressImageToDataUrl(img, MAX_W, MAX_H, QUALITY);
    const blob = dataURLToBlob(dataUrl);
    // create a File so Cloudinary receives original filename (optional)
    preparedFile = new File([blob], f.name.replace(/\s+/g,'_'), { type: blob.type });
    preview.src = dataUrl;
    preview.style.display = 'block';
    showMsg(`Preview ready — ${Math.round(blob.size/1024)} KB`);
    console.log('Prepared file size:', blob.size);
  } catch (err) {
    console.error(err);
    showError('Image processing failed.');
  }
});

/* Main one-click flow:
   1) Upload image to Cloudinary (progress shown)
   2) On success, POST JSON to backend with imageUrl = secure_url
*/
uploadBtn.addEventListener('click', async () => {
  clearMsg();
  if (!preparedFile) { showError('Please select an image first.'); return; }
  // disable UI
  toggleUi(false);
  progressEl.style.display = 'block';
  progressEl.value = 0;

  try {
    showMsg('Uploading image to Cloudinary...', 'hint');
    const cloudJson = await uploadToCloudinary(preparedFile, (pct) => {
      progressEl.value = pct;
    });
    const imageUrl = cloudJson.secure_url || cloudJson.url;
    if (!imageUrl) throw new Error('Cloudinary returned no secure_url.');

    showMsg('Image uploaded. Sending product data to backend...', 'hint');

    const burnTimeValue = document.getElementById('burnTimeHours').value.trim();
    const payload = {
      name: document.getElementById('name').value || 'Unnamed Product',
      category: document.getElementById('category').value || '',
      waxType: document.getElementById('waxType').value || '',
      weightGrams: Number(document.getElementById('weightGrams').value) || 0,
      price: Number(document.getElementById('price').value) || 0,
      quantityPack: Number(document.getElementById('quantityPack').value) || 1,
      customizableFragrance: document.getElementById('customizableFragrance').value === 'true',
      customizableColor: document.getElementById('customizableColor').value === 'true',
      imageUrl: imageUrl,
      altText: document.getElementById('altText').value || '',
    };
    if (burnTimeValue) payload.burnTimeHours = burnTimeValue;

    const backendRes = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-admin-secret': ADMIN_SECRET },
      body: JSON.stringify(payload)
    });

    if (!backendRes.ok) {
      const text = await backendRes.text();
      throw new Error(`Backend failed: ${backendRes.status} ${backendRes.statusText} — ${text.slice(0,300)}`);
    }

    const ct = backendRes.headers.get('Content-Type') || '';
    if (ct.includes('application/json')) {
      const data = await backendRes.json();
      showMsg('Product uploaded successfully ✔', 'success');
      console.log('Backend response:', data);
    } else {
      showMsg('Product uploaded (non-JSON backend response).', 'success');
      console.log('Backend response (text):', await backendRes.text());
    }

    resetForm();
  } catch (err) {
    console.error(err);
    showError(String(err.message || err));
  } finally {
    toggleUi(true);
    progressEl.style.display = 'none';
  }
});

/* ===== Helpers ===== */

function uploadToCloudinary(file, onProgress = null) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    const url = CLOUDINARY_URL;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);

    xhr.open('POST', url, true);

    xhr.upload.onprogress = function (e) {
      if (e.lengthComputable && onProgress) {
        const pct = Math.round((e.loaded / e.total) * 100);
        onProgress(pct);
      }
    };

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const json = JSON.parse(xhr.responseText);
            resolve(json);
          } catch (err) {
            reject(new Error('Invalid JSON from Cloudinary.'));
          }
        } else {
          reject(new Error(`Cloudinary upload failed: ${xhr.status} ${xhr.statusText} — ${xhr.responseText.slice(0,300)}`));
        }
      }
    };

    xhr.onerror = function () { reject(new Error('Network error during Cloudinary upload.')); };
    xhr.send(fd);
  });
}

function fileToImage(file) {
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = reject;
    img.src = url;
  });
}

function compressImageToDataUrl(img, maxW, maxH, quality) {
  return new Promise((resolve) => {
    let { width, height } = img;
    if (width > maxW || height > maxH) {
      const ratio = Math.min(maxW / width, maxH / height);
      width = Math.round(width * ratio);
      height = Math.round(height * ratio);
    }
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);
    resolve(canvas.toDataURL('image/jpeg', quality));
  });
}

function dataURLToBlob(dataurl) {
  const parts = dataurl.split(',');
  const mime = parts[0].match(/:(.*?);/)[1];
  const bstr = atob(parts[1]);
  let n = bstr.length;
  const u8 = new Uint8Array(n);
  while (n--) u8[n] = bstr.charCodeAt(n);
  return new Blob([u8], { type: mime });
}

function showMsg(text, type='hint') { msg.innerHTML = `<span class="${type==='success'?'success':(type==='error'?'error':'hint')}">${escapeHtml(text)}</span>`; }
function showError(text) { showMsg(text, 'error'); }
function clearMsg() { msg.innerHTML = ''; }
function escapeHtml(s){ return String(s).replace(/[&<>"'\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;'})[c]); }

function toggleUi(enabled){
  uploadBtn.disabled = !enabled;
  fileInput.disabled = !enabled;
  Array.from(document.querySelectorAll('input,select')).forEach(el => el.disabled = !enabled);
}

function resetForm(){
  document.getElementById('name').value = '';
  document.getElementById('category').value = '';
  document.getElementById('waxType').value = 'soy';
  document.getElementById('weightGrams').value = '';
  document.getElementById('burnTimeHours').value = '';
  document.getElementById('price').value = '';
  document.getElementById('quantityPack').value = '';
  document.getElementById('customizableFragrance').value = 'true';
  document.getElementById('customizableColor').value = 'true';
  document.getElementById('altText').value = '';
  document.getElementById('imageUpload').value = '';
  preview.style.display = 'none';
  preparedFile = null;
}
</script>
</body>
</html>
